kind: pipeline
type: docker
name: imgproxy

x-globals:
  image: &node-image node:10.17

steps:

  - name: yarn install
    image: *node-image
    commands:
      - yarn install

  - name: lint
    image: *node-image
    commands:
      - yarn lint

  - name: test
    image: *node-image
    commands:
      - yarn test

  - name: yarn build
    image: *node-image
    commands:
      - yarn build

  - name: docker build
    image: plugins/docker
    settings:
      repo: alikhil/vue-realworld-example-app
      tags: ${DRONE_COMMIT_SHA}-${DRONE_COMMIT_BRANCH}
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password

  - name: notify
    image: alikhil/drone-telegram:1.0.9
    environment:
      TELEGRAM_TOKEN:
        from_secret: telegram_token
      TELEGRAM_TO:
        from_secret: telegram_chat_id
    when:
      status:
        - success
        - failure
    settings:
      format: markdown
      message: >
        {{#success build.status}}
        âš™ï¸ Status: build successful âœ…
        {{else}}
        âš™ï¸ Status: build failed ğŸš¨
        {{/success}}

        ğŸ­ **{{commit.message}}**

        ğŸ”¸ Repository: ${DRONE_REPO}

        â˜˜ï¸ Branch: ** {{commit.branch}} **

        ğŸ“Œ Commit: [link]({{commit.link}})

        ğŸš€ Build URL: [build {{build.number}}]({{build.link}})

        ğŸ‘¨â€ğŸ’»  Author:  [@{{commit.author}}](https://github.com/{{commit.author}})
